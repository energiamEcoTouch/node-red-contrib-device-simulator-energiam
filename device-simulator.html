<script type="text/javascript">
    RED.nodes.registerType('device-simulator', {
        category: 'EnergIAM',
        color: '#27F555',
        defaults: {
            name:          { value: '' },
            topic:         { value: '' },
            template:      { value: '{}' },
            fields:        { value: '[]' },
            intervalMode:  { value: 'fixed' },
            intervalFixed: { value: 5000 },
            intervalMin:   { value: 1000 },
            intervalMax:   { value: 10000 },
            startupDelay:  { value: 0 }
        },
        inputs: 1,
        outputs: 1,
        icon: 'energiam.png',
        label: function () {
            return this.name || 'device simulator';
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        button: {
            enabled: function () { return !this.changed; },
            onclick: function () {
                const node = this;
                $.ajax({
                    url: 'device-simulator/' + node.id + '/inject',
                    type: 'POST',
                    success: function () {
                        RED.notify('Inyección manual enviada', { type: 'success', timeout: 1500 });
                    },
                    error: function () {
                        RED.notify('Error al inyectar', { type: 'error', timeout: 2000 });
                    }
                });
            }
        },

        oneditprepare: function () {
            const node = this;

            // ── Editor de template con modo maximizable (igual que nodo Template) ──
            this.editor = RED.editor.createEditor({
                id: 'node-input-template-editor',
                mode: 'ace/mode/json',
                value: $('#node-input-template').val() || '{}'
            });

            // ── Botón maximizar editor (igual que nodo Template nativo) ──
            $('#btn-expand-editor').on('click', function () {
                RED.editor.editJSON({
                    value: node.editor.getValue(),
                    complete: function (value) {
                        node.editor.setValue(value, -1);
                    }
                });
            });

            // ── Mostrar/ocultar campos de intervalo según modo ──
            function updateIntervalUI() {
                const mode = $('#node-input-intervalMode').val();
                if (mode === 'fixed') {
                    $('#row-intervalFixed').show();
                    $('#row-intervalMin, #row-intervalMax').hide();
                } else {
                    $('#row-intervalFixed').hide();
                    $('#row-intervalMin, #row-intervalMax').show();
                }
            }
            $('#node-input-intervalMode').on('change', updateIntervalUI);
            updateIntervalUI();

            // ── Secciones colapsables ──
            $('.ds-section-header').on('click', function () {
                const target = $(this).data('target');
                const icon   = $(this).find('.ds-chevron');
                $('#' + target).slideToggle(150, function () {
                    icon.text($('#' + target).is(':visible') ? '▲' : '▼');
                });
            });

            // ── Renderizar tabla de fields ──
            function renderFields(fieldsArray) {
                const tbody = $('#fields-tbody');
                tbody.empty();
                fieldsArray.forEach(function (f) {
                    addFieldRow(f.key, f.enabled, f.min, f.max, f.triggerOnChange);
                });
            }

            function addFieldRow(key, enabled, min, max, triggerOnChange) {
                const row = $('<tr>');

                row.append(
                    $('<td>').text(key).css({
                        padding: '4px 8px',
                        fontFamily: 'monospace',
                        fontSize: '12px',
                        color: '#333'
                    })
                );

                const chkEnabled = $('<input type="checkbox">').prop('checked', !!enabled);
                row.append($('<td>').css('text-align', 'center').append(chkEnabled));

                const inMin = $('<input type="number" step="any">').val(min != null ? min : '').css({ width: '68px' });
                row.append($('<td>').css('padding', '3px 4px').append(inMin));

                const inMax = $('<input type="number" step="any">').val(max != null ? max : '').css({ width: '68px' });
                row.append($('<td>').css('padding', '3px 4px').append(inMax));

                const chkTrigger = $('<input type="checkbox">').prop('checked', !!triggerOnChange);
                row.append($('<td>').css('text-align', 'center').append(chkTrigger));

                row.data('key', key);
                row.data('chkEnabled', chkEnabled);
                row.data('inMin', inMin);
                row.data('inMax', inMax);
                row.data('chkTrigger', chkTrigger);

                $('#fields-tbody').append(row);
            }

            // ── Parsear template y actualizar tabla preservando config existente ──
            function parseTemplateAndRebuild() {
                let obj = {};
                try {
                    const val = node.editor.getValue();
                    obj = JSON.parse(val);
                    $('#template-error').hide();
                } catch (e) {
                    $('#template-error').text('JSON inválido: ' + e.message).show();
                    return;
                }

                const currentFields = collectFields();
                const currentMap = {};
                currentFields.forEach(function (f) { currentMap[f.key] = f; });

                const newFields = [];
                Object.keys(obj).forEach(function (key) {
                    if (typeof obj[key] === 'number') {
                        const existing = currentMap[key] || {};
                        newFields.push({
                            key:             key,
                            enabled:         existing.enabled  || false,
                            min:             obj[key],              // siempre actualiza Min con el valor del JSON
                            max:             existing.max      != null ? existing.max : obj[key],
                            triggerOnChange: existing.triggerOnChange || false
                        });
                    }
                });

                renderFields(newFields);

                // Expandir sección de campos si estaba colapsada
                if (!$('#section-fields').is(':visible')) {
                    $('#section-fields').slideDown(150);
                    $('.ds-section-header[data-target="section-fields"] .ds-chevron').text('▲');
                }
            }

            $('#btn-parse-template').on('click', parseTemplateAndRebuild);

            // ── Recolectar fields desde la tabla ──
            function collectFields() {
                const result = [];
                $('#fields-tbody tr').each(function () {
                    const row = $(this);
                    result.push({
                        key:             row.data('key'),
                        enabled:         row.data('chkEnabled').prop('checked'),
                        min:             parseFloat(row.data('inMin').val()),
                        max:             parseFloat(row.data('inMax').val()),
                        triggerOnChange: row.data('chkTrigger').prop('checked')
                    });
                });
                return result;
            }

            // Cargar fields guardados
            let savedFields = [];
            try { savedFields = JSON.parse(node.fields || '[]'); } catch (e) { savedFields = []; }
            renderFields(savedFields);

            node._collectFields = collectFields;
        },

        oneditsave: function () {
            // Guardar valor del editor ACE en el input hidden
            $('#node-input-template').val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
            this.fields = JSON.stringify(this._collectFields());
        },

        oneditcancel: function () {
            if (this.editor) {
                this.editor.destroy();
                delete this.editor;
            }
        },

        oneditresize: function (size) {
            const rows     = $('#dialog-form>div:not(.node-input-template-row)');
            let   rowsH    = 0;
            rows.each(function () { rowsH += $(this).outerHeight(true); });
            const editorH  = size.height - rowsH - 45;
            this.editor.container.style.height = Math.max(editorH, 150) + 'px';
            this.editor.resize();
        }
    });
</script>

<script type="text/html" data-template-name="device-simulator">

    <!-- Nombre -->
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Nombre</label>
        <input type="text" id="node-input-name" placeholder="device simulator">
    </div>

    <!-- Topic -->
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-envelope"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="zigbee2mqtt/sensor_01">
    </div>

    <!-- ── SECCIÓN: Template JSON ── -->
    <div class="form-row ds-section-header" data-target="section-template"
         style="cursor:pointer; background:#f0f0f0; padding:6px 10px;
                border-radius:4px; margin-bottom:4px; user-select:none;">
        <i class="fa fa-code" style="margin-right:6px;"></i>
        <b>Template JSON</b>
        <span class="ds-chevron" style="float:right;">▲</span>
    </div>
    <div id="section-template">
        <div class="form-row node-input-template-row" style="position:relative;">
            <!-- Input oculto para persistir el valor -->
            <input type="hidden" id="node-input-template">
            <div style="position:relative;">
                <div id="node-input-template-editor"
                     style="width:100%; height:200px; min-height:150px;
                            border:1px solid #ccc; border-radius:4px;"></div>
                <button id="btn-expand-editor" type="button" title="Maximizar editor"
                        style="position:absolute; top:4px; right:4px; z-index:10;
                               background:rgba(255,255,255,0.85); border:1px solid #ccc;
                               border-radius:3px; padding:2px 6px; cursor:pointer;
                               font-size:13px; line-height:1;">
                    <i class="fa fa-expand"></i>
                </button>
            </div>
            <div id="template-error"
                 style="color:red; font-size:11px; margin-top:4px; display:none;"></div>
        </div>
        <div class="form-row">
            <button id="btn-parse-template" class="red-ui-button" style="width:100%;">
                <i class="fa fa-refresh"></i>&nbsp; Actualizar campos variables desde JSON
            </button>
        </div>
    </div>

    <!-- ── SECCIÓN: Campos Variables ── -->
    <div class="form-row ds-section-header" data-target="section-fields"
         style="cursor:pointer; background:#f0f0f0; padding:6px 10px;
                border-radius:4px; margin-bottom:4px; margin-top:8px; user-select:none;">
        <i class="fa fa-sliders" style="margin-right:6px;"></i>
        <b>Campos variables</b>
        <span class="ds-chevron" style="float:right;">▲</span>
    </div>
    <div id="section-fields">
        <div class="form-row" style="overflow-x:auto; margin-bottom:4px;">
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                    <tr style="background:#1a1a2e; color:#fff;">
                        <th style="padding:5px 8px; text-align:left;">Campo</th>
                        <th style="padding:5px 8px;">Variable</th>
                        <th style="padding:5px 8px;">Min</th>
                        <th style="padding:5px 8px;">Max</th>
                        <th style="padding:5px 8px;">Dispara si cambia</th>
                    </tr>
                </thead>
                <tbody id="fields-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- ── SECCIÓN: Intervalo ── -->
    <div class="form-row ds-section-header" data-target="section-interval"
         style="cursor:pointer; background:#f0f0f0; padding:6px 10px;
                border-radius:4px; margin-bottom:4px; margin-top:8px; user-select:none;">
        <i class="fa fa-clock-o" style="margin-right:6px;"></i>
        <b>Intervalo de inyección</b>
        <span class="ds-chevron" style="float:right;">▲</span>
    </div>
    <div id="section-interval">
        <div class="form-row">
            <label for="node-input-intervalMode">Modo</label>
            <select id="node-input-intervalMode" style="width:auto;">
                <option value="fixed">Fijo</option>
                <option value="random">Aleatorio</option>
            </select>
        </div>
        <div class="form-row" id="row-intervalFixed">
            <label for="node-input-intervalFixed">Cada (ms)</label>
            <input type="number" id="node-input-intervalFixed" min="100" style="width:120px;">
        </div>
        <div class="form-row" id="row-intervalMin" style="display:none;">
            <label for="node-input-intervalMin">Mín (ms)</label>
            <input type="number" id="node-input-intervalMin" min="100" style="width:120px;">
        </div>
        <div class="form-row" id="row-intervalMax" style="display:none;">
            <label for="node-input-intervalMax">Máx (ms)</label>
            <input type="number" id="node-input-intervalMax" min="100" style="width:120px;">
        </div>
        <div class="form-row">
            <label for="node-input-startupDelay">Delay inicio (ms)</label>
            <input type="number" id="node-input-startupDelay" min="0" style="width:120px;"
                   placeholder="0">
            <span style="margin-left:8px; font-size:11px; color:#888;">
                tiempo de espera antes del primer disparo tras deploy
            </span>
        </div>
    </div>

</script>

<script type="text/html" data-help-name="device-simulator">
    <p>Simula dispositivos IoT (zigbee2mqtt, sensores, medidores) inyectando objetos JSON con campos variables.</p>
    <h3>Uso</h3>
    <ol>
        <li>Pegá el JSON base en <b>Template JSON</b>.</li>
        <li>Presioná <b>Actualizar campos variables desde JSON</b> para detectar los campos numéricos.</li>
        <li>Marcá <b>Variable</b> en los campos que querés que varíen y definí su rango Min/Max.</li>
        <li>Marcá <b>Dispara si cambia</b> para enviar el mensaje solo cuando ese campo cambia.</li>
        <li>Configurá el intervalo fijo o aleatorio y el delay de inicio.</li>
    </ol>
    <h3>Entradas</h3>
    <p>Cualquier mensaje recibido dispara una inyección inmediata, independientemente del timer.</p>
    <h3>Salidas</h3>
    <p>El nodo emite <code>msg.topic</code> y <code>msg.payload</code> con el objeto simulado.</p>
    <h3>Botón</h3>
    <p>El botón lateral en el canvas dispara una inyección manual sin necesidad de un nodo externo.</p>
</script>
